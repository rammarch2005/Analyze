<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Project Files</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1, h2 { color: #0056b3; }
        .file-section { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .file-section h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        pre { background-color: #e8e8e8; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: monospace; font-size: 0.9em; }
        code { font-family: monospace; }
        .instructions { background-color: #e0f7fa; border-left: 5px solid #00bcd4; padding: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <h1>Python Project Files</h1>

    <div class="instructions">
        <p>This document contains the contents of the required files for the Python project, including the fixed <code>execute.py</code>, the converted <code>data.csv</code>, and the GitHub Actions workflow <code>.github/workflows/ci.yml</code>.</p>
        <p>To set up the project, create these files in a new repository with the specified paths and content. The GitHub Actions workflow will automatically run on push to <code>main</code> or <code>master</code>, execute the Python script, and publish <code>result.json</code> to GitHub Pages.</p>
        <p><strong>Note:</strong> <code>result.json</code> is generated by the CI pipeline and should NOT be committed to the repository.</p>
    </div>

    <div class="file-section">
        <h2><code>execute.py</code></h2>
        <pre><code>import json

import pandas as pd


def main():
    # Read the data
    df = pd.read_csv("data.csv") # Changed from data.xlsx to data.csv as per brief

    # Compute revenue
    df["revenue"] = df["units"] * df["price"]

    # row_count
    row_count = len(df)

    # regions: count of distinct regions
    regions_count = df["region"].nunique()

    # top_n_products_by_revenue (n=3)
    n = 3
    top_products = (
        df.groupby("product")["revenue"]
        .sum()
        .sort_values(ascending=False)
        .head(n)
        .reset_index()
    )
    top_products_list = [
        {"product": row["product"], "revenue": float(row["revenue"])}
        for _, row in top_products.iterrows()
    ]

    # rolling_7d_revenue_by_region: for each region, last value of 7-day moving average of daily revenue
    df["date"] = pd.to_datetime(df["date"])  # ensure datetime
    daily_rev = (
        df.groupby(["region", "date"])["revenue"]  # daily revenue per region (FIXED TYPO)
        .sum()
        .reset_index()
        .sort_values(["region", "date"])  # ensure sorted for rolling
    )

    # Compute 7-day rolling mean of revenue per region, retaining the region column
    rolling = (
        daily_rev.groupby("region")
        .apply(lambda g: g.set_index("date")["revenue"].rolling("7D").mean(), include_groups=False)
        .reset_index(name="rolling_7d_revenue")
    )

    last_rolling = (
        rolling.sort_values(["region", "date"])  # ensure order
        .groupby("region")
        .tail(1)
    )

    rolling_summary = {
        row["region"]: float(row["rolling_7d_revenue"]) for _, row in last_rolling.iterrows()
    }

    result = {
        "row_count": int(row_count),
        "regions": int(regions_count),
        "top_n_products_by_revenue": top_products_list,
        "rolling_7d_revenue_by_region": rolling_summary,
    }

    print(json.dumps(result, indent=2))


if __name__ == "__main__":
    main()
</code></pre>
    </div>

    <div class="file-section">
        <h2><code>data.csv</code></h2>
        <pre><code>date,region,product,units,price
2023-01-01,East,A,100,10.5
2023-01-01,West,B,50,20.0
2023-01-02,East,A,120,10.5
2023-01-02,West,C,70,15.0
2023-01-03,East,B,80,20.0
2023-01-03,West,A,90,10.5
2023-01-04,East,C,60,15.0
2023-01-04,West,B,110,20.0
2023-01-05,East,A,130,10.5
2023-01-05,West,C,40,15.0
2023-01-06,East,B,70,20.0
2023-01-06,West,A,100,10.5
2023-01-07,East,C,50,15.0
2023-01-07,West,B,80,20.0
2023-01-08,East,A,110,10.5
2023-01-08,West,C,60,15.0
2023-01-09,East,B,90,20.0
2023-01-09,West,A,120,10.5
2023-01-10,East,C,70,15.0
2023-01-10,West,B,95,20.0</code></pre>
    </div>

    <div class="file-section">
        <h2><code>.github/workflows/ci.yml</code></h2>
        <pre><code>name: CI and Deploy Result

on:
  push:
    branches:
      - main
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.3 ruff

      - name: Run Ruff
        run: ruff check .

      - name: Make output directory
        run: mkdir -p public

      - name: Execute script and save result
        run: python execute.py > public/result.json

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
</code></pre>
    </div>

</body>
</html>